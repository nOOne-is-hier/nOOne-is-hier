name: Update README metrics (all repos, 30d)

on:
  schedule:
    - cron: '0 0 * * *'   # ë§¤ì¼ 00:00â€¯UTC (KSTâ€¯09:00)
  workflow_dispatch:

jobs:
  commit-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      DAYS: 30
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
    # ------------------------------------------------------------------ #
    - uses: actions/checkout@v4

    # 0) â–¶ .gitignoreì— ì„ì‹œ íŒŒì¼ ì¶”ê°€  ------------------------- #
    - name: Ensure temp files are ignored
      run: |
        cat <<'EOF' >> .gitignore
        # added by workflowâ€Šâ€”â€Štemp analytics
        commit-hours.md
        hours.txt
        hourcount.txt
        me.txt
        own.txt
        member.txt
        repos.txt
        EOF

    # 1) ì „ì²´ ë ˆí¬ ëª©ë¡ ìˆ˜ì§‘ ----------------------------------- #
    - name: Collect repositories (owner + member, fork ì œì™¸)
      id: repos
      run: |
        set -euo pipefail
        gh api user --jq .login > me.txt

        GH_TOKEN=$GH_TOKEN gh api "user/repos?type=owner&per_page=100" --paginate \
          --jq '.[]|select(.fork==false)|.full_name' > own.txt

        GH_TOKEN=$GH_TOKEN gh api "user/repos?type=member&per_page=100" --paginate \
          --jq '.[]|select(.fork==false)|.full_name' > member.txt

        sort -u own.txt member.txt > repos.txt
        echo "count=$(wc -l < repos.txt)" >> "$GITHUB_OUTPUT"

    # 2) ìµœê·¼ Nì¼ ì»¤ë°‹ ì‹œê° ì§‘ê³„ ------------------------------- #
    - name: Aggregate commit hours (last ${{ env.DAYS }}â€¯days)
      run: |
        set -euo pipefail
        since=$(date -u -d "$DAYS days ago" '+%Y-%m-%dT%H:%M:%SZ')
        > hours.txt
    
        # â–¶ ë ˆí¬ë³„ ì»¤ë°‹ ì‹œê° ìˆ˜ì§‘
        while read repo; do
          def=$(GH_TOKEN=$GH_TOKEN gh api "repos/$repo" --jq .default_branch)
          GH_TOKEN=$GH_TOKEN gh api "repos/$repo/commits?sha=$def&since=$since&per_page=100" \
            --paginate --jq '.[].commit.author.date' >> hours.txt || true
        done < repos.txt
    
        # â–¶ ì‹œê°„ëŒ€ë³„ ë¹ˆë„ ê³„ì‚°
        total=$(wc -l < hours.txt | xargs)
        morning=0 daytime=0 evening=0 night=0
    
        while read iso; do
          hr=${iso#*T}; hr=${hr%%:*}            # HH ë¶€ë¶„ ì¶”ì¶œ
          case $hr in
            06|07|08|09|10|11) morning=$((morning+1)) ;;
            12|13|14|15|16|17) daytime=$((daytime+1)) ;;
            18|19|20|21|22|23) evening=$((evening+1)) ;;
            *)                 night=$((night+1))   ;;  # 00â€‘05
          esac
        done < hours.txt
    
        # â–¶ ì§„í–‰ë°” ìƒì„± í•¨ìˆ˜
        progress () {               # $1=count   $2=total
          local filled=$(( $1*20 / $2 ))         # 20ì¹¸ ì¤‘ ê½‰ ì°¬ ë¸”ë¡
          local bar=$(printf 'â–ˆ%.0s' $(seq 1 $filled))
          bar=$(printf '%-20s' "$bar")           # 20ì¹¸ ê¸¸ì´ë¡œ íŒ¨ë”©
          echo "${bar// /â–‘}"                     # ë‚¨ì€ ì¹¸ì€ â–‘
        }
    
        # â–¶ commit-hours.md ì¶œë ¥
        {
          echo "#### ğŸ•’ Commits in Last ${DAYS} Days by TimeÂ Period"
          echo "_Last updated: $(date -u '+%Y-%m-%d %H:%M UTC')_"
          echo
          printf "ğŸŒ Morning    %4d commits  %s  %5.1f%%\n" \
                 $morning  "$(progress $morning $total)"  "$(awk "BEGIN{print $morning*100/$total}")"
          printf "ğŸŒ† Daytime   %4d commits  %s  %5.1f%%\n" \
                 $daytime  "$(progress $daytime $total)"  "$(awk "BEGIN{print $daytime*100/$total}")"
          printf "ğŸŒƒ Evening   %4d commits  %s  %5.1f%%\n" \
                 $evening  "$(progress $evening $total)"  "$(awk "BEGIN{print $evening*100/$total}")"
          printf "ğŸŒ™ Night     %4d commits  %s  %5.1f%%\n" \
                 $night    "$(progress $night   $total)"  "$(awk "BEGIN{print $night*100/$total}")"
        } > commit-hours.md


    # 3) READMEì— í…Œì´ë¸” ì£¼ì… --------------------------------- #
    - name: Inject table into README
      run: |
        s='<!--START_SECTION:commit_hours-->'
        e='<!--END_SECTION:commit_hours-->'
        awk -v s="$s" -v e="$e" '
          index($0,s) {
            print gensub(/^[[:space:]]*/, "", 1) s
            while ((getline<"commit-hours.md")>0) print
            skip=1; next
          }
          index($0,e) { skip=0 }
          skip!=1 { print }
        ' README.md > README.tmp && mv README.tmp README.md

    # 4) ë³€ê²½ ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ìë™ ì»¤ë°‹ ----------------------- #
    - uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "ğŸ¤– chore: update ${DAYS}d allâ€‘repo commitâ€‘hour stats"
        file_pattern: README.md      # READMEë§Œ ì»¤ë°‹
        # skip_dirty_check ê¸°ë³¸ê°’(false) â†’ ë³€ê²½ì´ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ì„±ê³µ

    # 5) (ì„ íƒ) ë¡œê·¸ìš© diff ------------------------------------ #
    - name: Show README diff (debug)
      if: always()
      run: git diff --stat README.md || echo "âœ… No diff"
