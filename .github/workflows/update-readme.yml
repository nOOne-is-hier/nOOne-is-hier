name: Update README metrics

on:
  schedule:
    # ë§¤ì¼ 00:00â€¯UTC(=09:00â€¯KST) ì‹¤í–‰
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write          # README.md push ê¶Œí•œ

    env:                        # ëª¨ë“  ìŠ¤í…ì—ì„œ ê³µí†µ ì‚¬ìš©
      GH_TOKEN: ${{ secrets.GH_TOKEN }}         # â† PAT(repo ê¶Œí•œ) ì„ GH_TOKEN ìœ¼ë¡œ
      REPO: ${{ github.repository }}            # owner/repo
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0        # (í•„ìš”ì‹œ) ì»¤ë°‹ ë¡œê·¸ ì „ë¶€

      # 1) ìµœê·¼ 7â€¯ì¼ ì»¤ë°‹â€‘ì‹œê°„ëŒ€ í†µê³„ ìƒì„±
      - name: Build lastâ€‘7â€‘day commitâ€‘hour table
        shell: bash
        run: |
          set -eo pipefail

          since=$(date -u -d '7 days ago' +'%Y-%m-%dT%H:%M:%SZ')

          {
            echo "#### ğŸ•’ Commits in LastÂ 7Â Days by Hour"
            echo "| Hour | # Commits |"
            echo "|:----:|:---------:|"
          } > commit-hours.md

          # GitHub REST API: ê¸°ë³¸ ë¸Œëœì¹˜ í•œì • + since í•„í„°
          gh api "repos/$REPO/commits" \
            -F sha="$DEFAULT_BRANCH" \
            -F since="$since" \
            -F per_page=100 \
            --paginate \
            --jq '.[].commit.author.date' |
          cut -dT -f2 | cut -d: -f1 |       # ì‹œ( Hour ) ì¶”ì¶œ
          sort | uniq -c |                  # ì¹´ìš´íŠ¸
          awk '{printf "| %02d:00 | %d |\n", $2, $1}' >> commit-hours.md

      # 2) README ì£¼ì„ êµ¬ê°„ ë®ì–´ì“°ê¸°
      - name: Inject table into README
        shell: bash
        run: |
          start='<!--START_SECTION:commit_hours-->'
          end='<!--END_SECTION:commit_hours-->'
          awk -v s="$start" -v e="$end" '
            $0==s {print; while ((getline < "commit-hours.md")>0) print; skip=1; next}
            $0==e {skip=0}
            skip!=1 {print}
          ' README.md > README.tmp && mv README.tmp README.md

      # 3) ë³€ê²½ ì‚¬í•­ ìë™ ì»¤ë°‹
      - name: Commit updated README
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ğŸ¤– chore: update lastâ€‘7â€‘day commitâ€‘hour stats"
          file_pattern: README.md
