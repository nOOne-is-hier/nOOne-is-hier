name: Update README metrics

on:
  schedule:
    # 매일 00:00 UTC(=09:00 KST) 실행
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write          # README.md push 권한

    env:                        # 모든 스텝에서 공통 사용
      GH_TOKEN: ${{ secrets.GH_TOKEN }}         # ← PAT(repo 권한) 을 GH_TOKEN 으로
      REPO: ${{ github.repository }}            # owner/repo
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0        # (필요시) 커밋 로그 전부

      # 1) 최근 7 일 커밋‑시간대 통계 생성
      - name: Build last‑7‑day commit‑hour table
        shell: bash
        run: |
          set -eo pipefail

          since=$(date -u -d '7 days ago' +'%Y-%m-%dT%H:%M:%SZ')

          {
            echo "#### 🕒 Commits in Last 7 Days by Hour"
            echo "| Hour | # Commits |"
            echo "|:----:|:---------:|"
          } > commit-hours.md

          # GitHub REST API: 기본 브랜치 한정 + since 필터
          gh api "repos/$REPO/commits" \
            -F sha="$DEFAULT_BRANCH" \
            -F since="$since" \
            -F per_page=100 \
            --paginate \
            --jq '.[].commit.author.date' |
          cut -dT -f2 | cut -d: -f1 |       # 시( Hour ) 추출
          sort | uniq -c |                  # 카운트
          awk '{printf "| %02d:00 | %d |\n", $2, $1}' >> commit-hours.md

      # 2) README 주석 구간 덮어쓰기
      - name: Inject table into README
        shell: bash
        run: |
          start='<!--START_SECTION:commit_hours-->'
          end='<!--END_SECTION:commit_hours-->'
          awk -v s="$start" -v e="$end" '
            $0==s {print; while ((getline < "commit-hours.md")>0) print; skip=1; next}
            $0==e {skip=0}
            skip!=1 {print}
          ' README.md > README.tmp && mv README.tmp README.md

      # 3) 변경 사항 자동 커밋
      - name: Commit updated README
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "🤖 chore: update last‑7‑day commit‑hour stats"
          file_pattern: README.md
