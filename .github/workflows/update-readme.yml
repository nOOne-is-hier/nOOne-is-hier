name: Update README metrics

on:
  schedule:
    # ë§¤ì¼ 00:00(UTC) = 09:00(KST)ì— ì‹¤í–‰
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write          # README.md í‘¸ì‹œ ê¶Œí•œ

    steps:
      # 1) ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v4

      # 2) ìµœê·¼ 7ì¼ ì»¤ë°‹â€‘ì‹œê°„ëŒ€ í…Œì´ë¸” ìƒì„±
      - name: Generate lastâ€‘7â€‘days hourly commit table
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}   # gh CLI ì¸ì¦ìš©
        shell: bash
        run: |
          since=$(date -u -d '7 days ago' +'%Y-%m-%dT%H:%M:%SZ')

          # í‘œ í—¤ë”
          {
            echo "#### ğŸ•’ Commits in LastÂ 7Â Days by Hour"
            echo "| Hour | # Commits |"
            echo "|:----:|:---------:|"
          } > commit-hours.md

          # ì‹œê°„(HH) ì¶”ì¶œ â†’ ì¹´ìš´íŠ¸ â†’ í‘œ í–‰ append
          gh api repos/${{ github.repository }}/commits \
            --paginate \
            -F since="$since" \
            -F per_page=100 \
            --jq '.[].commit.author.date' |
          cut -dT -f2 | cut -d: -f1 |        # HH ì¶”ì¶œ
          sort | uniq -c |                   # ê°¯ìˆ˜ ì§‘ê³„
          awk '{printf "| %02d:00 | %d |\n", $2, $1}' >> commit-hours.md

      # 3) READMEì— í…Œì´ë¸” ì‚½ì… (START/END ë§ˆì»¤ ì‚¬ì´ ë®ì–´ì“°ê¸°)
      - name: Inject table into README
        shell: bash
        run: |
          start='<!--START_SECTION:commit_hours-->'
          end='<!--END_SECTION:commit_hours-->'
          awk -v s="$start" -v e="$end" '
            $0==s {print; while ((getline l<"commit-hours.md")>0) print l; skip=1; next}
            $0==e {skip=0}
            skip!=1 {print}
          ' README.md > README.tmp && mv README.tmp README.md

      # 4) ë³€ê²½ ì‚¬í•­ ìë™ ì»¤ë°‹
      - name: Commit updated README
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ğŸ¤– chore: update lastâ€‘7â€‘day commitâ€‘hour stats"
          file_pattern: README.md
