name: Update README metrics

on:
  schedule:
    - cron: '0 0 * * *'        # ë§¤ì¼ 00:00 UTC
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      REPO: ${{ github.repository }}

    steps:
      - uses: actions/checkout@v4

      # 1) ê¸°ë³¸ ë¸Œëœì¹˜ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸° (schedule ë³€ìˆ˜ë¥¼ ëª» ì“¸ ë•Œ ëŒ€ë¹„)
      - name: Get default branch
        id: branch
        run: |
          def_branch=$(gh repo view "$REPO" --json defaultBranchRef -q .defaultBranchRef.name)
          echo "DEFAULT_BRANCH=$def_branch" >> "$GITHUB_OUTPUT"

      # 2) ìµœê·¼ 7ì¼ ì»¤ë°‹â€‘ì‹œê°„ëŒ€ í†µê³„ ìƒì„±
      - name: Build lastâ€‘7â€‘day commitâ€‘hour table
        env:
          DEFAULT_BRANCH: ${{ steps.branch.outputs.DEFAULT_BRANCH }}
        run: |
          set -eo pipefail
          echo "ğŸ” Repo: $REPO  |  Branch: $DEFAULT_BRANCH"

          since=$(date -u -d '7 days ago' +'%Y-%m-%dT%H:%M:%SZ')

          {
            echo "#### ğŸ•’ Commits in LastÂ 7Â Days by Hour"
            echo "| Hour | # Commits |"
            echo "|:----:|:---------:|"
          } > commit-hours.md

          gh api "repos/$REPO/commits" \
            -F sha="$DEFAULT_BRANCH" \
            -F since="$since" \
            -F per_page=100 --paginate \
            --jq '.[].commit.author.date' |
          cut -dT -f2 | cut -d: -f1 |
          sort | uniq -c |
          awk '{printf "| %02d:00 | %d |\n", $2, $1}' >> commit-hours.md

      # 3) READMEì— ì£¼ì…
      - name: Inject table into README
        run: |
          start='<!--START_SECTION:commit_hours-->'
          end='<!--END_SECTION:commit_hours-->'
          awk -v s="$start" -v e="$end" '
            $0==s {print; while ((getline < "commit-hours.md")>0) print; skip=1; next}
            $0==e {skip=0}
            skip!=1 {print}
          ' README.md > README.tmp && mv README.tmp README.md

      # 4) ìë™ ì»¤ë°‹
      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ğŸ¤– chore: update lastâ€‘7â€‘day commitâ€‘hour stats"
          file_pattern: README.md
