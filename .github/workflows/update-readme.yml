name: Update README metrics

on:
  schedule:
    - cron: '0 0 * * *'           # ë§¤ì¼ 00:00 UTC
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write             # README.md í‘¸ì‹œ ê¶Œí•œ

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      REPO: ${{ github.repository }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: gh login
        run: echo "$GH_TOKEN" | gh auth login --with-token

      - name: Get default branch
        id: branch
        run: |
          def=$(gh repo view "$REPO" --json defaultBranchRef -q .defaultBranchRef.name)
          echo "DEFAULT_BRANCH=$def" >> "$GITHUB_OUTPUT"

      - name: Build lastâ€‘7â€‘day commitâ€‘hour table
        env:
          DEFAULT_BRANCH: ${{ steps.branch.outputs.DEFAULT_BRANCH }}
        run: |
          set -eo pipefail
          echo "ðŸ”Ž Repo=$REPO  Branch=$DEFAULT_BRANCH"

          since=$(date -u -d '7 days ago' '+%Y-%m-%dT%H:%M:%SZ')

          {
            echo "#### ðŸ•’ Commits in LastÂ 7Â Days by Hour"
            echo "| Hour | # Commits |"
            echo "|:----:|:---------:|"
          } > commit-hours.md

          # ê¸°ë³¸ ë¸Œëžœì¹˜ì—ì„œ ìµœê·¼ 7ì¼ ì»¤ë°‹ ê°€ì ¸ì˜¤ê¸° (GET)!
          gh api "repos/$REPO/commits?sha=$DEFAULT_BRANCH&since=$since&per_page=100" \
            --paginate --jq '.[].commit.author.date' |
          cut -dT -f2 | cut -d: -f1 |
          sort | uniq -c |
          awk '{printf "| %02d:00 | %d |\n", $2, $1}' >> commit-hours.md

      - name: Inject table into README
        run: |
          start='<!--START_SECTION:commit_hours-->'
          end='<!--END_SECTION:commit_hours-->'
          awk -v s="$start" -v e="$end" '
            $0==s {print; while ((getline<"commit-hours.md")>0) print; skip=1; next}
            $0==e {skip=0}
            skip!=1 {print}
          ' README.md > README.tmp && mv README.tmp README.md

      - name: Commit updated README
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ðŸ¤– chore: update lastâ€‘7â€‘day commitâ€‘hour stats"
          file_pattern: README.md
