name: Update README metrics

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions: { contents: write }

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      REPO: ${{ github.repository }}

    steps:
      - uses: actions/checkout@v4

      - name: Get default branch
        id: branch
        run: |
          def=$(gh repo view "$REPO" --json defaultBranchRef -q .defaultBranchRef.name)
          echo "DEFAULT_BRANCH=$def" >> "$GITHUB_OUTPUT"

      - name: Build lastâ€‘7â€‘day commitâ€‘hour table
        env:
          DEFAULT_BRANCH: ${{ steps.branch.outputs.DEFAULT_BRANCH }}
        run: |
          set -eo pipefail
          echo "ðŸ”Ž Repo=$REPO  Branch=$DEFAULT_BRANCH"

          since=$(date -u -d '7 days ago' +'%Y-%m-%dT%H:%M:%SZ')

          {
            echo "#### ðŸ•’ Commits in LastÂ 7Â Days by Hour"
            echo "| Hour | # Commits |"
            echo "|:----:|:---------:|"
          } > commit-hours.md

          # ë¸Œëžœì¹˜ íŒŒë¼ë¯¸í„° ì œê±° â†’ ê¸°ë³¸ ë¸Œëžœì¹˜ ìžë™ ì„ íƒ
          gh api "repos/$REPO/commits" \
            -F since="$since" \
            -F per_page=100 --paginate \
            --jq '.[].commit.author.date' |
          cut -dT -f2 | cut -d: -f1 |
          sort | uniq -c |
          awk '{printf "| %02d:00 | %d |\n", $2, $1}' >> commit-hours.md

      - name: Inject table into README
        run: |
          start='<!--START_SECTION:commit_hours-->'
          end='<!--END_SECTION:commit_hours-->'
          awk -v s="$start" -v e="$end" '
            $0==s {print; while ((getline<"commit-hours.md")>0) print; skip=1; next}
            $0==e {skip=0}
            skip!=1 {print}
          ' README.md > README.tmp && mv README.tmp README.md

      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ðŸ¤– chore: update lastâ€‘7â€‘day commitâ€‘hour stats"
          file_pattern: README.md
