name: Update README metrics (all repos, 30d)

on:
  schedule:
    - cron: '0 0 * * *'        # ë§¤ì¼ 00:00 UTC
  workflow_dispatch:

jobs:
  commit-stats:
    runs-on: ubuntu-latest
    permissions: { contents: write }

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      DAYS: 30                        # ìµœê·¼ Nì¼

    steps:
    - uses: actions/checkout@v4

    # 1) ì „ì²´ ë ˆí¬ ëª©ë¡ (ì†Œìœ  + ê¸°ì—¬), í¬í¬ ì œì™¸
    - name: Collect repositories
      id: repos
      run: |
        gh api user --jq .login > me.txt
        ME=$(cat me.txt)

        gh api user/repos --paginate --jq '.[] | select(.fork==false) | .full_name' > own.txt
        gh api user/repos -F type=member --paginate --jq '.[] | select(.fork==false) | .full_name' > member.txt

        sort -u own.txt member.txt > repos.txt
        echo "count=$(wc -l < repos.txt)" >> "$GITHUB_OUTPUT"

    # 2) ê° ë ˆí¬ ê¸°ë³¸ ë¸Œëœì¹˜ & ìµœê·¼ 30ì¼ ì»¤ë°‹ ì‹œê° ëª¨ìœ¼ê¸°
    - name: Aggregate commits (last ${{ env.DAYS }} days)
      run: |
        since=$(date -u -d "$DAYS days ago" '+%Y-%m-%dT%H:%M:%SZ')
        > hours.txt                    # ë¹ˆ íŒŒì¼ ë§Œë“¤ê¸°

        while read repo; do
          def=$(gh api "repos/$repo" --jq .default_branch)
          gh api "repos/$repo/commits?sha=$def&since=$since&per_page=100" \
            --paginate --jq '.[].commit.author.date' >> hours.txt || true
        done < repos.txt

        # ì‹œê°„ëŒ€ë³„ ì§‘ê³„
        sort hours.txt | cut -dT -f2 | cut -d: -f1 |
        uniq -c > hourcount.txt

        {
          echo "#### ğŸ•’ Commits in Last ${DAYS}Â Days by Hour (AllÂ Repos)"
          echo "| Hour | # Commits |"
          echo "|:----:|:---------:|"
          while read c h; do
            printf "| %02d:00 | %d |\n" "$h" "$c"
          done < hourcount.txt
        } > commit-hours.md

    # 3) README ì£¼ì…
    - name: Inject table
      run: |
        s='<!--START_SECTION:commit_hours-->'
        e='<!--END_SECTION:commit_hours-->'
        awk -v s="$s" -v e="$e" '
          $0==s {print; while ((getline<"commit-hours.md")>0) print; skip=1; next}
          $0==e {skip=0}
          skip!=1 {print}
        ' README.md > README.tmp && mv README.tmp README.md

    # 4) ìë™ ì»¤ë°‹
    - uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "ğŸ¤– chore: update ${DAYS}d allâ€‘repo commitâ€‘hour stats"
        file_pattern: README.md
