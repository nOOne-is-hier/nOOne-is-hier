name: Update README metrics (all repos, 30d)

on:
  schedule:
    - cron: '0 0 * * *'   # ë§¤ì¼ 00:00â€¯UTC (KSTâ€¯09:00)
  workflow_dispatch:

jobs:
  commit-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write           # README ì»¤ë°‹
      # í•„ìš”í•˜ë©´ ì¶”ê°€ ì˜ˆ) id-token: write

    env:
      DAYS: 30
      GH_TOKEN: ${{ secrets.GH_TOKEN }}   # ë°˜ë“œì‹œ repoâ€¯ê¶Œí•œ í¬í•¨

    steps:
    # ------------------------------------------------------------------ #
    - uses: actions/checkout@v4

    # 1) ì „ì²´ ë ˆí¬ ëª©ë¡ ìˆ˜ì§‘ ----------------------------------- #
    - name: Collect repositories (owner + member, fork ì œì™¸)
      id: repos
      run: |
        set -euo pipefail
        gh api user --jq .login > me.txt

        # ì†Œìœ  ë ˆí¬
        GH_TOKEN=$GH_TOKEN gh api "user/repos?type=owner&per_page=100" --paginate \
          --jq '.[] | select(.fork==false) | .full_name' > own.txt

        # ë©¤ë²„ ë ˆí¬
        GH_TOKEN=$GH_TOKEN gh api "user/repos?type=member&per_page=100" --paginate \
          --jq '.[] | select(.fork==false) | .full_name' > member.txt

        sort -u own.txt member.txt > repos.txt
        echo "count=$(wc -l < repos.txt)" >> "$GITHUB_OUTPUT"

    - name: ğŸª“ Dump repos.txt (debug)
      if: always()
      run: |
        echo "### ğŸ“¦ ë ˆí¬ ëª©ë¡ (ì´ $(wc -l < repos.txt)ê°œ)"
        cat repos.txt

    # 2) ìµœê·¼ Nì¼ ì»¤ë°‹ ì‹œê° ì§‘ê³„ ------------------------------- #
    - name: Aggregate commit hours (last ${{ env.DAYS }}â€¯days)
      run: |
        set -euo pipefail
        since=$(date -u -d "$DAYS days ago" '+%Y-%m-%dT%H:%M:%SZ')
        > hours.txt

        while read repo; do
          echo "â–¶ $repo"
          def=$(GH_TOKEN=$GH_TOKEN gh api "repos/$repo" --jq .default_branch)
          GH_TOKEN=$GH_TOKEN gh api "repos/$repo/commits?sha=$def&since=$since&per_page=100" \
            --paginate --jq '.[].commit.author.date' >> hours.txt || true
        done < repos.txt

        if [ ! -s hours.txt ]; then
          echo "âš ï¸  ìµœê·¼ $DAYSâ€¯ì¼ê°„ ì»¤ë°‹ì´ ì—†ìŠµë‹ˆë‹¤."
        fi

        # ì‹œê°„ëŒ€ë³„ ì§‘ê³„ â†’ commit-hours.md
        sort hours.txt | cut -dT -f2 | cut -d: -f1 | uniq -c > hourcount.txt
        {
          echo "#### ğŸ•’ Commits in Last ${DAYS} Days by Hour (All Repos)"
          echo "_Last updated: $(date -u "+%Y-%m-%d %H:%M UTC")_"
          echo "| Hour | # Commits |"
          echo "|:----:|:---------:|"
          awk '{printf "| %02d:00 | %d |\n", $2, $1}' hourcount.txt
        } > commit-hours.md

    - name: ğŸª“ Dump commit-hours.md (debug)
      if: always()
      run: cat commit-hours.md || true

    # 3) READMEì— í…Œì´ë¸” ì£¼ì… --------------------------------- #
    - name: Inject table into README
      run: |
        s='<!--START_SECTION:commit_hours-->'
        e='<!--END_SECTION:commit_hours-->'
        awk -v s="$s" -v e="$e" '
          $0==s {print; while ((getline<"commit-hours.md")>0) print; skip=1; next}
          $0==e {skip=0}
          skip!=1 {print}
        ' README.md > README.tmp
        mv README.tmp README.md

    - name: ğŸª“ Show injected section (debug)
      if: always()
      run: |
        grep -n -A3 -B2 '<!--START_SECTION:commit_hours-->' README.md || true

    # 4) ë³€ê²½ ì‚¬í•­ ìë™ ì»¤ë°‹ ---------------------------------- #
    - uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: |
          ğŸ¤– chore: update ${DAYS}d allâ€‘repo commitâ€‘hour stats
        file_pattern: README.md
